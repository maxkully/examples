# Suggest video

## Task

Как бы вы выбирали похожие сущности, которые могли бы максимально заинтересовать пользователя?

* Есть ID и категории текущего видео. 
* Пользователь может быть анонимом, а может быть зарегистрированным. 
  * Если он зарегистрированный, то у вас есть список его любимых видео. 
* У каждого видео есть кол-во лайков и дислайков, кол-во просмотров. 

Какой алгоритм, который бы работал в условиях высоких нагрузок, вы могли-бы предложить?

## Possible solution

Одним из возможных решений является предоставление пользователю списка видео с тем же набором категорий, что и у текущего видео
Для того, чтобы в условиях высоких нагрузок получить такой список, необходимо выполнение следующих условий
1. При добавлении категорий к видео необходимо сортировать список категорий
2. Создать индекс для полнотекстового поиска (GiST) для колонки с категориями, перечисленными через запятую

Таким образом для поиска похожих видео нужно будет:
* взять категории видео из поля categories, где они уже отсортированы
* по этому полю сделать запрос к таблице с видео
* исключить из запроса текущее видео.
* в случае, если пользователь авторизованный - исключить из запроса список любимых видео
* в идеале, для анонимного пользователя нужно бы еще хранить список уже просмотренных видео и их также исключить из запроса 
* сортировку сделать в зависимости от предпочтений пользователя (новые, просматриваемые, популярные, хиты и так далее), для этого нужно убедиться в наличии индексов на поля views, likes, dislikes

Данный алгоритм является базовым, но в реальности может не работать в случае, если для видео навешивается избыточное количество категорий.

В абсолюте в реальных данных может оказаться ситуация, когда каждое видео имеет свою уникальную категорию.
В этом случае нужно усложнить алгоритм:
* предварительно вычислять количество видео для каждой категории и хранить это в справочнике
* получить "ядро" категорий из текущего видео
  * отбросить категорию, которая на данный момент имеет больше всего видео
  * отбросить категорию, которая на данный момент имеет меньше всего видео
* Для полученного "ядра" повторить базовый алгоритм

Данный алгоритм математически будет выводить самые похожие видео
В реальности пользователю не всегда нужен список однообразных видео, которые найдет такой чисто математический подход
Для этого случая алгоритм можно также еще раз усложнить

* Предварительно вычислить категории видео с самым большим количеством лайков 
* Сделать "мутацию" "ядра" категорий видео путем добавления наиболее "любимой" категории, которой нет среди категорий текущего видео
* Повторить базовый алгоритм

Данный подходы все являются базовыми
Их можно разнообразить различными статистическими подходами при получении необходимы показателей
Например, применение весовых коэффициентов к категориям видео, вычисленных по существующим данным и так далее.
